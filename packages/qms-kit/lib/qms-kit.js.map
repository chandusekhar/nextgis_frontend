{"version":3,"file":"qms-kit.js","sources":["../src/QmsKit.ts"],"sourcesContent":["import { StarterKit } from '@nextgis/webmap';\r\n\r\nexport interface QmsOptions {\r\n  url: string;\r\n}\r\n\r\ninterface GeoserviceInList {\r\n  id: number;\r\n  guid: string;\r\n  name: string;\r\n  desc: string;\r\n  type: string;\r\n  epsg: number;\r\n}\r\n\r\ninterface Geoservice {\r\n  id: number;\r\n  guid: string;\r\n  name: string;\r\n  desc: string;\r\n  type: string;\r\n  epsg: number;\r\n  license_name: string;\r\n  license_url: string;\r\n  copyright_text: string;\r\n  copyright_url: string;\r\n  terms_of_use_url: string;\r\n  url: string;\r\n  z_min: any;\r\n  z_max: any;\r\n  y_origin_top: boolean;\r\n  icon: number;\r\n}\r\n\r\nexport class QmsKit implements StarterKit {\r\n\r\n  options: QmsOptions = {\r\n    url: 'https://qms.nextgis.com',\r\n  };\r\n\r\n  url: string;\r\n  map;\r\n\r\n  constructor(options?: QmsOptions) {\r\n    this.options = { ...this.options, ...options };\r\n    this.url = this.options.url;\r\n  }\r\n\r\n  getLayerAdapters() {\r\n    return Promise.resolve([{\r\n      name: 'QMS',\r\n      createAdapter: (webmap) => Promise.resolve(this._createAdapter(webmap)),\r\n    }]);\r\n\r\n  }\r\n\r\n  async getQmsServices() {\r\n    return loadJSON<GeoserviceInList[]>(this.url + '/api/v1/geoservices/');\r\n  }\r\n\r\n  private _createAdapter(map) {\r\n    const url = this.url;\r\n    this.map = map;\r\n    const alias = {\r\n      tms: 'TILE',\r\n    };\r\n    const adapter = function(m, options) {\r\n      this.map = m;\r\n      this.name = options.id;\r\n    };\r\n\r\n    adapter.prototype.addLayer = function(options) {\r\n      return loadJSON<Geoservice>(url + '/api/v1/geoservices/' + options.qmsid).then((service) => {\r\n        if (service) {\r\n          const type = alias[service.type];\r\n          const webMapAdapter = map.layerAdapters[type];\r\n          if (webMapAdapter) {\r\n            if (type === 'TILE') {\r\n              options.url = service.url;\r\n              options.name = service.name;\r\n              options.attribution = service.copyright_text;\r\n              return webMapAdapter.prototype.addLayer.call(this, options);\r\n            }\r\n          }\r\n        }\r\n      });\r\n    };\r\n    return adapter;\r\n  }\r\n}\r\n\r\nfunction loadJSON<T = any>(url): Promise<T> {\r\n  return new Promise<T>((resolve, reject) => {\r\n    const xmlHttp = new XMLHttpRequest();\r\n    xmlHttp.onreadystatechange = () => {\r\n      if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {\r\n        if (xmlHttp.responseText) {\r\n          try {\r\n            resolve(JSON.parse(xmlHttp.responseText));\r\n          } catch (er) {\r\n            reject(er);\r\n          }\r\n        }\r\n      }\r\n    };\r\n    xmlHttp.open('GET', fixUrlStr(url), true); // true for asynchronous\r\n    xmlHttp.send(null);\r\n  });\r\n}\r\n\r\nfunction fixUrlStr(url: string) {\r\n  // remove double slash\r\n  return url.replace(/([^:]\\/)\\/+/g, '$1');\r\n}\r\n"],"names":[],"mappings":"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"}