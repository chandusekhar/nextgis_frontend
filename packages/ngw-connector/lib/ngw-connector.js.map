{"version":3,"file":"ngw-connector.js","sources":["../src/ngw-connector.ts"],"sourcesContent":["\nimport { ResourceItem } from './types/ResourceItem';\nimport { RequestItemsParamsMap } from './types/RequestItemsParamsMap';\n\n// region inline polyfills\n// tslint:disable-next-line:max-line-length\n// Object.assign || Object.defineProperty(Object, \"assign\", { enumerable: !1, configurable: !0, writable: !0, value: function (e, r) { \"use strict\"; if (null == e) throw new TypeError(\"Cannot convert first argument to object\"); for (let t = Object(e), n = 1; n < arguments.length; n++) { let o = arguments[n]; if (null != o) for (let a = Object.keys(Object(o)), c = 0, b = a.length; c < b; c++) { let i = a[c], l = Object.getOwnPropertyDescriptor(o, i); void 0 !== l && l.enumerable && (t[i] = o[i]) } } return t } });\n\ntype simple = string | number | boolean;\n\ntype cbParams = (params: Params) => simple;\n\ninterface Router {\n  [name: string]: string[];\n}\n\ninterface Params {\n  [name: string]: simple | cbParams;\n}\n\ninterface RequestItemsResponseMap {\n  'resource.item': ResourceItem;\n  'resource.child': any;\n  [x: string]: { [x: string]: any };\n}\n\nexport interface NgwConnectorOptions {\n  route?: string;\n  baseUrl?: string;\n}\n\nexport interface RequestOptions {\n  method?: 'POST' | 'GET';\n  data?: any;\n}\n\nconst OPTIONS: NgwConnectorOptions = {\n  route: '/api/component/pyramid/route',\n  // baseUrl: 'http://'\n};\n\nexport class NgwConnector {\n\n  options: NgwConnectorOptions = {};\n  private route;\n\n  private _loadingQueue = {};\n  private _loadingStatus = {};\n\n  constructor(options) {\n    this.options = Object.assign({}, OPTIONS, options || {});\n  }\n\n  connect(callback: (router: Router) => void, context: any): void {\n    const self = this;\n    if (this.route) {\n      callback.call(context || this, this.route);\n    } else {\n      this.makeQuery(this.options.route, function (route) {\n        self.route = route;\n        callback.call(this, route);\n      }, {}, {}, context);\n    }\n  }\n\n  request<K extends keyof RequestItemsParamsMap>(\n    name: K,\n    callback?: (data: RequestItemsResponseMap[K]) => void,\n    params?: RequestItemsParamsMap[K] | {},\n    options?: RequestOptions,\n    error?: (er: Error) => void,\n    context?: any): void {\n    this.connect((apiItems) => {\n      for (const a in apiItems) {\n        if (apiItems.hasOwnProperty(a)) {\n          if (a === name) {\n            const apiItem = apiItems[a].slice();\n            let url = apiItem.shift();\n            if (apiItem.length) {\n              params = params || {};\n              const replaceParams = {};\n              for (let fry = 0; fry < apiItem.length; fry++) {\n                const arg = apiItem[fry];\n                replaceParams[fry] = '{' + arg + '}';\n                if (params[arg] === undefined) {\n                  throw new Error('`' + arg + '`' + ' url api argument is not specified');\n                }\n              }\n              url = template(url, replaceParams);\n            }\n            this.makeQuery(url, callback, params, options, this, error);\n          }\n        }\n      }\n    }, context || this);\n  }\n\n  post<K extends keyof RequestItemsParamsMap>(\n    name: K,\n    callback: (data: RequestItemsResponseMap[K]) => void,\n    options?: RequestOptions,\n    error?: (er: Error) => void,\n    params?: RequestItemsParamsMap[K] | {},\n    context?: any): void {\n\n    options = options || {};\n    options.method = 'POST';\n    this.request(name, callback, params, options, error, context);\n  }\n\n  makeQuery(\n    url: string,\n    callback: ({ }) => void,\n    params: Params,\n    options: RequestOptions,\n    context: any,\n    error?: (er: Error) => void): void {\n\n    context = context || this;\n    url = (this.options.baseUrl ? this.options.baseUrl : '') + url;\n    if (url) {\n      if (params) {\n        url = template(url, params);\n      }\n      // remove double slash\n      url = url.replace(/([^:]\\/)\\/+/g, '$1');\n      if (!this._loadingStatus[url]) {\n        this._loadingStatus[url] = true;\n\n        this._getJson(url, (data) => {\n          callback.call(context, data);\n          this._loadingStatus[url] = false;\n          this._exequteLoadingQueue(url, data);\n        }, options, context, (er) => {\n          this._loadingStatus[url] = false;\n          this._exequteLoadingQueue(url, er, true);\n          if (error) {\n            error.call(context, er);\n          } else {\n            throw new Error(er);\n          }\n        });\n      } else {\n        this._loadingStatus[url] = false;\n        this._setLoadingQueue(url, callback, context, error);\n      }\n    } else {\n      throw new Error('No `url` parameter set for option ' + name);\n    }\n\n  }\n\n  _setLoadingQueue(name, callback, context, error) {\n    this._loadingQueue[name] = this._loadingQueue[name] || {\n      name,\n      waiting: [],\n    };\n    this._loadingQueue[name].waiting.push({\n      callback,\n      error,\n      context,\n      timestamp: new Date(),\n    });\n  }\n\n  _exequteLoadingQueue(name, data, isError?) {\n    const queue = this._loadingQueue[name];\n    if (queue) {\n      for (let fry = 0; fry < queue.waiting.length; fry++) {\n        const wait = queue.waiting[fry];\n        if (isError) {\n          if (wait.error) {\n            wait.error.call(wait.context, data);\n          }\n        } else {\n          wait.callback.call(wait.context, data);\n        }\n      }\n      queue.waiting = [];\n    }\n  }\n\n  _getJson(url: string, callback, options: RequestOptions, context, error) {\n    return loadJSON(url, callback, options, context, error);\n  }\n}\n\nfunction loadJSON(url, callback, options: RequestOptions = {}, context, error) {\n  const xmlHttp = new XMLHttpRequest();\n  xmlHttp.onreadystatechange = () => {\n    if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {\n      if (xmlHttp.responseText) {\n        try {\n          callback(JSON.parse(xmlHttp.responseText));\n        } catch (er) {\n          error(er);\n        }\n      }\n    }\n  };\n  xmlHttp.open(options.method || 'GET', url, true); // true for asynchronous\n  xmlHttp.send(options.data ? JSON.stringify(options.data) : null);\n}\n\n// https://github.com/Leaflet/Leaflet/blob/b507e21c510b53cd704fb8d3f89bb46ea925c8eb/src/core/Util.js#L165\nconst templateRe = /\\{ *([\\w_-]+) *\\}/g;\n\nfunction template(str, data) {\n  return str.replace(templateRe, (s, key) => {\n    let value = data[key];\n\n    if (value === undefined) {\n      throw new Error('No value provided for letiable ' + s);\n\n    } else if (typeof value === 'function') {\n      value = value(data);\n    }\n    return value;\n  });\n}\n"],"names":[],"mappings":"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"}